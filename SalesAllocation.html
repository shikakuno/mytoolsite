<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>å£²ä¸Šé…åˆ†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --panel2:#0c162b;
      --text:#e9eefb;
      --muted:#b8c3de;
      --line:#223457;

      --green:#1f8a4c;
      --green2:#165f36;
      --blue:#2b6de2;
      --blue2:#1e4fb2;

      --danger:#e25252;
      --warning:#ffcc66;
      --ok:#61d17a;

      --shadow: 0 10px 25px rgba(0,0,0,.25);
      --radius: 14px;
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Noto Sans JP", "Yu Gothic", Meiryo, sans-serif;
      background: radial-gradient(1200px 700px at 10% 10%, rgba(43,109,226,.16), transparent 60%),
                  radial-gradient(1000px 650px at 90% 20%, rgba(31,138,76,.14), transparent 55%),
                  linear-gradient(180deg, #0b1220, #070d18);
      color: var(--text);
    }
    header{
      padding: 26px 18px 6px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1{
      margin:0 0 10px;
      font-size: 26px;
      letter-spacing: .02em;
    }
    .subtitle{
      margin:0 0 12px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }

    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 18px 36px;
      display: grid;
      gap: 16px;
    }

    section{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    section > h2{
      margin: 0 0 12px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.6fr 1fr 1fr 1fr;
      gap: 12px;
      align-items: end;
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
    }
    textarea, input[type="text"], select, input[type="number"]{
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(12,22,43,.75);
      color: var(--text);
      padding: 10px 10px;
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease, opacity .15s ease;
    }
    textarea{ min-height: 44px; resize: vertical; }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(43,109,226,.7);
      box-shadow: 0 0 0 3px rgba(43,109,226,.18);
    }
    input[disabled], select[disabled], textarea[disabled]{
      opacity: .55;
      cursor: not-allowed;
    }
    input[readonly]{
      opacity: .85;
    }

    .row-actions{
      display:flex;
      gap:10px;
      justify-content: flex-end;
      align-items:center;
    }

    .btn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      font-weight: 600;
      letter-spacing: .01em;
      white-space: nowrap;
    }
    .btn:hover{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.18);
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      background: linear-gradient(180deg, rgba(43,109,226,.85), rgba(30,79,178,.85));
      border-color: rgba(43,109,226,.65);
    }
    .btn-primary:hover{
      background: linear-gradient(180deg, rgba(43,109,226,.95), rgba(30,79,178,.95));
    }
    .btn-danger{
      background: rgba(226,82,82,.14);
      border-color: rgba(226,82,82,.45);
      color: #ffd6d6;
    }
    .btn-danger:hover{
      background: rgba(226,82,82,.22);
      border-color: rgba(226,82,82,.62);
    }
    .btn-small{
      padding: 7px 10px;
      border-radius: 10px;
      font-size: 12px;
    }

    .cards{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 14px;
      padding: 12px;
    }
    .card-title{
      font-weight: 800;
      margin: 0 0 6px;
      font-size: 14px;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .card-meta{
      color: var(--muted);
      font-size: 12px;
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 0 0 10px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15);
    }
    .tag strong{ color: var(--text); font-weight: 800; }

    .table-wrap{
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.07);
      background: rgba(12,22,43,.55);
    }
    table{
      border-collapse: collapse;
      width: 100%;
      min-width: 1200px;
    }
    th, td{
      border-bottom: 1px solid rgba(255,255,255,.07);
      border-right: 1px solid rgba(255,255,255,.05);
      padding: 8px;
      vertical-align: top;
    }
    th:last-child, td:last-child{ border-right: none; }
    tr:last-child td{ border-bottom: none; }

    thead th{
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 12px;
      letter-spacing: .02em;
      text-align: center;
      color: rgba(255,255,255,.92);
      padding: 10px 8px;
    }

    .th-green{
      background: linear-gradient(180deg, rgba(31,138,76,.35), rgba(22,95,54,.30));
      border-bottom-color: rgba(31,138,76,.35);
    }
    .th-blue{
      background: linear-gradient(180deg, rgba(43,109,226,.35), rgba(30,79,178,.30));
      border-bottom-color: rgba(43,109,226,.35);
    }

    .cell-stack{
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .cell-stack input{
      padding: 8px 8px;
      border-radius: 10px;
      font-size: 12px;
    }
    .cell-stack .hours-input{
      background: rgba(255,255,255,.06);
    }
    .cell-stack .cost-input{
      background: rgba(255,255,255,.04);
    }

    .muted{
      color: var(--muted);
      font-size: 12px;
    }

    .pl-area{
      display: grid;
      gap: 14px;
    }
    .pl-table{
      width: 100%;
      min-width: 920px;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(12,22,43,.55);
      border: 1px solid rgba(255,255,255,.07);
    }
    .pl-table table{
      min-width: 920px;
    }
    .pl-table caption{
      caption-side: top;
      text-align: left;
      padding: 10px 12px;
      font-weight: 900;
      color: rgba(255,255,255,.94);
      background: rgba(0,0,0,.18);
      border-bottom: 1px solid rgba(255,255,255,.07);
    }
    .pl-table th{
      background: rgba(255,255,255,.06);
      font-weight: 800;
    }
    .pl-table td{
      font-size: 12px;
    }
    .pl-left{
      width: 260px;
      font-weight: 800;
      text-align: left;
      white-space: nowrap;
    }
    .num{
      text-align: right;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    .pl-group{
      background: rgba(255,255,255,.03);
    }
    .pl-sub{
      color: rgba(255,255,255,.85);
    }

    /* info-box: ä»•æ§˜ã§éè¡¨ç¤ºï¼ˆCSSãŒæ®‹ã£ã¦ã„ã¦ã‚‚ã‚ˆã„ï¼‰ */
    .info-box{
      display:none;
    }

    @media (max-width: 860px){
      .grid{
        grid-template-columns: 1fr;
      }
      .row-actions{
        justify-content: flex-start;
      }
      .pl-left{ width: 220px; }
    }
  </style>
</head>

<body>
  <header>
    <h1>å£²ä¸Šé…åˆ†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
    <p class="subtitle">æ¡ˆä»¶æƒ…å ±ãƒ»åŸä¾¡å…¥åŠ›ãƒ»æç›Šï¼ˆPLï¼‰ã‚’ã²ã¨ã¤ã®ç”»é¢ã§æ‰±ã†ç°¡æ˜“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ï¼‰</p>
  </header>

  <main>
    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³1ï¼šæ¡ˆä»¶æƒ…å ± -->
    <section>
      <h2>ğŸ“ æ¡ˆä»¶æƒ…å ±</h2>

      <div class="grid">
        <div>
          <label for="projectName">æ¡ˆä»¶å</label>
          <textarea id="projectName" placeholder="ä¾‹ï¼‰â—‹â—‹ã‚·ã‚¹ãƒ†ãƒ æ›´æ”¹ï¼ˆãƒ•ã‚§ãƒ¼ã‚º1ï¼‰"></textarea>
        </div>

        <div>
          <label for="projectAmount">å—æ³¨é‡‘é¡</label>
          <input id="projectAmount" type="text" inputmode="numeric" placeholder="ä¾‹ï¼‰12000000" />
        </div>

        <div>
          <label for="startMonth">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹æœˆ</label>
          <select id="startMonth"></select>
        </div>

        <div>
          <label for="endMonth">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ‚äº†æœˆ</label>
          <select id="endMonth"></select>
        </div>
      </div>

      <div class="row-actions" style="margin-top:12px;">
        <button class="btn btn-primary" onclick="addProject()">ï¼‹ æ¡ˆä»¶ã‚’è¿½åŠ </button>
      </div>

      <div class="cards" id="projectCards"></div>
    </section>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸä¾¡å…¥åŠ› -->
    <section>
      <h2>ğŸ’° ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸä¾¡å…¥åŠ›</h2>

      <div class="row-actions" style="margin-bottom:12px;">
        <button class="btn btn-primary" onclick="addCostRow()">ï¼‹ è¡Œã‚’è¿½åŠ </button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="th-green">æ¡ˆä»¶å</th>
              <th class="th-green">è¦å“¡å</th>
              <th class="th-green">çµ„ç¹”</th>
              <th class="th-green">è²»ç›®</th>
              <th class="th-green">ãƒ©ãƒ³ã‚¯</th>
              <th class="th-green">å˜ä¾¡</th>
              <th class="th-blue">10æœˆ</th>
              <th class="th-blue">11æœˆ</th>
              <th class="th-blue">12æœˆ</th>
              <th class="th-blue">1æœˆ</th>
              <th class="th-blue">2æœˆ</th>
              <th class="th-blue">3æœˆ</th>
              <th class="th-green">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="costTbody"></tbody>
        </table>
      </div>

      <p class="muted" style="margin:10px 0 0;">
        â€»æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¦ã‚‚åŸä¾¡è¡Œã¯ç”»é¢ä¸Šã«æ®‹ã‚Šã¾ã™ãŒã€é›†è¨ˆãƒ»PL ã‹ã‚‰ã¯é™¤å¤–ã•ã‚Œã¾ã™ã€‚
      </p>
    </section>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³3ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæç›Š -->
    <section>
      <h2>ğŸ“ˆ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæç›Š</h2>
      <div class="pl-area" id="plArea"></div>
    </section>
  </main>

  <script>
    // =========================
    // Data / Master
    // =========================
    const months = ['10', '11', '12', '1', '2', '3'];

    const rankPrices = {
      6: 8818,
      5: 7791,
      4: 7067,
      3: 6598,
      2: 6123
    };

    let projects = [];     // { id, name, amount, startMonth, endMonth }
    let costRowSeq = 1;
    let projectSeq = 1;

    const dummyMembers = ['è¦å“¡A', 'è¦å“¡B', 'è¦å“¡C', 'è¦å“¡D', 'è¦å“¡E'];
    const orgs = ['å–¶æ¥­', 'é–‹ç™º', 'ãƒ†ã‚¯ãƒ', 'ç®¡ç†'];
    const expenseTypes = [
      { value: '', label: 'ï¼ˆæœªé¸æŠï¼‰' },
      { value: 'employee', label: 'ç¤¾å“¡äººå·¥è²»' },
      { value: 'outsourcing', label: 'å¤–æ³¨è²»' },
      { value: 'direct', label: 'ç›´èª²çµŒè²»' }
    ];

    // =========================
    // Utilities
    // =========================
    function toIntSafe(v){
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : 0;
    }

    function parseNumberLike(str){
      if (str == null) return 0;
      const s = String(str).replace(/[^\d.-]/g, '');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }

    function formatComma(n){
      if (!Number.isFinite(n)) n = 0;
      return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatCommaMaybeBlank(n, blankIfZero=false){
      if (!Number.isFinite(n)) n = 0;
      if (blankIfZero && n === 0) return '';
      return formatComma(n);
    }

    function formatPercent(rate){
      const r = Number.isFinite(rate) ? rate : 0;
      return (r * 100).toFixed(1) + '%';
    }

    // å…¥åŠ›æ¬„ï¼ˆtextï¼‰ã‚’ã€Œæ•°å€¤ + ã‚«ãƒ³ãƒã€ã«æ•´å½¢
    function formatCurrencyInput(el){
      const raw = el.value;
      const n = parseNumberLike(raw);
      if (raw.trim() === '') return; // ç©ºã¯ãã®ã¾ã¾
      el.value = formatComma(Math.max(0, n));
    }

    // caret ã®ç´°ã‹ã„åˆ¶å¾¡ã¯çœç•¥ï¼ˆã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ååˆ†å‹•ãå®Ÿè£…ï¼‰
    function onCurrencyTyping(el){
      const n = parseNumberLike(el.value);
      if (el.value.trim() === '') return;
      el.value = formatComma(Math.max(0, n));
    }

    function buildMonthSelectOptions(withPlaceholder=true){
      let html = '';
      if (withPlaceholder) html += '<option value="">-- é¸æŠ --</option>';
      for (const m of months){
        html += `<option value="${m}">${m}æœˆ</option>`;
      }
      return html;
    }

    // =========================
    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³1ï¼šæ¡ˆä»¶æƒ…å ±
    // =========================
    function addProject(){
      const nameEl = document.getElementById('projectName');
      const amtEl  = document.getElementById('projectAmount');
      const sEl    = document.getElementById('startMonth');
      const eEl    = document.getElementById('endMonth');

      const name = nameEl.value.trim();
      const amount = parseNumberLike(amtEl.value);
      const startMonth = sEl.value;
      const endMonth = eEl.value;

      if (!name || amount <= 0 || !startMonth || !endMonth){
        alert('æ¡ˆä»¶åã€å—æ³¨é‡‘é¡ï¼ˆ0ã‚ˆã‚Šå¤§ãã„ï¼‰ã€é–‹å§‹æœˆã€çµ‚äº†æœˆã¯å¿…é ˆã§ã™ã€‚');
        return;
      }

      const project = {
        id: 'p' + (projectSeq++),
        name,
        amount: Math.round(amount),
        startMonth,
        endMonth
      };
      projects.push(project);

      // clear
      nameEl.value = '';
      amtEl.value = '';
      sEl.value = '';
      eEl.value = '';

      renderProjectList();
      updateProjectSelects();
      updateSummary();
    }

    function deleteProject(id){
      const target = projects.find(p => p.id === id);
      if (!target) return;

      if (!confirm(`æ¡ˆä»¶ã€Œ${target.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆåŸä¾¡è¡Œã¯æ®‹ã‚Šã¾ã™ãŒã€é›†è¨ˆãƒ»PL ã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã™ï¼‰`)){
        return;
      }
      projects = projects.filter(p => p.id !== id);
      renderProjectList();
      updateProjectSelects();
      updateSummary();
    }

    function renderProjectList(){
      const area = document.getElementById('projectCards');
      if (projects.length === 0){
        area.innerHTML = `<div class="muted">æ¡ˆä»¶ãŒæœªç™»éŒ²ã§ã™ã€‚ã€Œï¼‹ æ¡ˆä»¶ã‚’è¿½åŠ ã€ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>`;
        return;
      }

      area.innerHTML = projects.map(p => {
        return `
          <div class="card">
            <div class="card-title">${escapeHtml(p.name)}</div>
            <div class="card-meta">
              <span class="tag">å—æ³¨é‡‘é¡ï¼š<strong>${formatComma(p.amount)}</strong></span>
              <span class="tag">æœŸé–“ï¼š<strong>${p.startMonth}æœˆã€œ${p.endMonth}æœˆ</strong></span>
            </div>
            <div class="row-actions">
              <button class="btn btn-danger btn-small" onclick="deleteProject('${p.id}')">å‰Šé™¤</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // projects ã®æ¡ˆä»¶åã‚’åŸä¾¡è¡Œã®æ¡ˆä»¶selectã¸åæ˜ 
    function updateProjectSelects(){
      const selects = document.querySelectorAll('select.project-select');
      selects.forEach(sel => {
        const current = sel.value;

        // options ã‚’å†æ§‹ç¯‰ï¼ˆç¾åœ¨å€¤ãŒ projects ã«å­˜åœ¨ã—ãªã„å ´åˆã¯ã€Œå‰Šé™¤æ¸ˆã€ã‚’è¿½åŠ ã—ã¦ä¿æŒï¼‰
        let html = `<option value="">é¸æŠã—ã¦ãã ã•ã„</option>`;
        for (const p of projects){
          html += `<option value="${p.id}">${escapeHtml(p.name)}</option>`;
        }

        const stillExists = current && projects.some(p => p.id === current);
        if (current && !stillExists){
          // æ—¢å­˜è¡Œã®å€¤ã‚’ä¿æŒï¼ˆãŸã ã—é›†è¨ˆã¯é™¤å¤–ã•ã‚Œã‚‹ï¼‰
          html += `<option value="${current}">ï¼ˆå‰Šé™¤æ¸ˆã®æ¡ˆä»¶ï¼‰</option>`;
        }

        sel.innerHTML = html;

        // restore selection
        sel.value = current;
      });
    }

    // =========================
    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³2ï¼šåŸä¾¡å…¥åŠ›
    // =========================
    function addCostRow(){
      const rowId = 'r' + (costRowSeq++);
      const tbody = document.getElementById('costTbody');

      const memberOptions = dummyMembers.map(n => `<option value="${escapeAttr(n)}">${escapeHtml(n)}</option>`).join('');
      const orgOptions = orgs.map(n => `<option value="${escapeAttr(n)}">${escapeHtml(n)}</option>`).join('');
      const expenseOptions = expenseTypes.map(x => `<option value="${x.value}">${escapeHtml(x.label)}</option>`).join('');
      const rankOptions = [6,5,4,3,2].map(r => `<option value="${r}">${r}</option>`).join('');

      const monthCells = months.map(m => {
        return `
          <td>
            <div class="cell-stack">
              <input type="number"
                     class="hours-input"
                     data-month="${m}"
                     min="0" max="250" step="0.1"
                     placeholder="å·¥æ•°"
                     oninput="onHoursChange('${rowId}','${m}')">
              <input type="text"
                     class="cost-input"
                     data-month="${m}"
                     placeholder="è²»ç”¨"
                     oninput="onCostInputChange('${rowId}','${m}')">
            </div>
          </td>
        `;
      }).join('');

      const tr = document.createElement('tr');
      tr.id = rowId;
      tr.innerHTML = `
        <td>
          <select class="project-select" onchange="onProjectChange('${rowId}')">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </td>
        <td>
          <select>
            ${memberOptions}
          </select>
        </td>
        <td>
          <select>
            ${orgOptions}
          </select>
        </td>
        <td>
          <select class="expense-type" onchange="onExpenseTypeChange('${rowId}')">
            ${expenseOptions}
          </select>
        </td>
        <td>
          <select class="rank-select" onchange="onRankChange('${rowId}')">
            ${rankOptions}
          </select>
        </td>
        <td>
          <input type="text" class="unit-price" placeholder="å˜ä¾¡" oninput="onUnitPriceTyping('${rowId}')">
        </td>
        ${monthCells}
        <td style="text-align:center;">
          <button class="btn btn-danger btn-small" onclick="deleteCostRow('${rowId}')">å‰Šé™¤</button>
        </td>
      `;

      tbody.appendChild(tr);

      updateProjectSelects();

      // åˆæœŸçŠ¶æ…‹ã¯è²»ç›®æœªé¸æŠã¨ã—ã¦ã€Œä¸¡æ–¹å…¥åŠ›å¯ã€å¯„ã‚Š
      // ãŸã ã—æ¡ˆä»¶æœªé¸æŠãªã‚‰æœˆæ´»æ€§åˆ¶å¾¡ã¯ã—ãªã„ï¼ˆå…¨æœˆæœŸé–“å†…æ‰±ã„ã§ã‚‚ã‚ˆã„ï¼‰
      onExpenseTypeChange(rowId);
      applyProjectMonthActivation(rowId);
      updateSummary();
    }

    function deleteCostRow(rowId){
      const tr = document.getElementById(rowId);
      if (tr) tr.remove();
      updateSummary();
    }

    function getRowEl(rowId){
      return document.getElementById(rowId);
    }

    function getSelectedProjectByRow(rowId){
      const row = getRowEl(rowId);
      if (!row) return null;
      const sel = row.querySelector('select.project-select');
      const pid = sel ? sel.value : '';
      if (!pid) return null;
      return projects.find(p => p.id === pid) || null; // å‰Šé™¤æ¸ˆãªã‚‰ null
    }

    function onProjectChange(rowId){
      applyProjectMonthActivation(rowId);
      // æœŸé–“åˆ¶å¾¡ã®çµæœã€å€¤ã‚¯ãƒªã‚¢ãŒèµ·ãã‚‹ã®ã§ PL åæ˜ 
      updateSummary();
    }

    // ===== æ¡ˆä»¶æœŸé–“åˆ¤å®šï¼ˆä»•æ§˜ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    function isMonthInProject(project, month){
      if (!project) return true; // æœªé¸æŠãªã‚‰å…¨æœˆæœŸé–“å†…æ‰±ã„ã§ã‚‚ã‚ˆã„
      const sIdx = months.indexOf(project.startMonth);
      const eIdx = months.indexOf(project.endMonth);
      const idx  = months.indexOf(month);

      if (sIdx === -1 || eIdx === -1 || idx === -1) return true;

      if (sIdx <= eIdx){
        return sIdx <= idx && idx <= eIdx;
      }else{
        // æŠ˜ã‚Šè¿”ã—
        return idx >= sIdx || idx <= eIdx;
      }
    }

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æœŸé–“ï¼ˆæœˆé…åˆ—ä¸Šã®é †ï¼‰ã‚’ startâ†’end ã§ä½œã‚‹ï¼ˆç´¯è¨ˆãƒ»é€²æ—ç”¨ï¼‰
    function getProjectMonthSequence(project){
      if (!project) return [...months];
      const sIdx = months.indexOf(project.startMonth);
      const eIdx = months.indexOf(project.endMonth);
      if (sIdx === -1 || eIdx === -1) return [...months];

      const seq = [];
      let i = sIdx;
      while (true){
        seq.push(months[i]);
        if (i === eIdx) break;
        i = (i + 1) % months.length;
        // å¿µã®ãŸã‚ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
        if (seq.length > 12) break;
      }
      return seq;
    }

    function applyProjectMonthActivation(rowId){
      const row = getRowEl(rowId);
      if (!row) return;

      const project = getSelectedProjectByRow(rowId);

      // æœŸé–“å¤–ã¯ disabled & å€¤ã‚¯ãƒªã‚¢
      months.forEach(m => {
        const inPeriod = isMonthInProject(project, m);
        const hoursEl = row.querySelector(`.hours-input[data-month="${m}"]`);
        const costEl  = row.querySelector(`.cost-input[data-month="${m}"]`);

        if (!hoursEl || !costEl) return;

        if (!inPeriod){
          hoursEl.value = '';
          costEl.value  = '';
          hoursEl.disabled = true;
          costEl.disabled  = true;
          hoursEl.readOnly = true;
          costEl.readOnly  = true;
        }else{
          // æœŸé–“å†…ã¯è²»ç›®ãƒ«ãƒ¼ãƒ«ã§æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ±ºã‚ã‚‹
          hoursEl.disabled = false;
          costEl.disabled  = false;
          hoursEl.readOnly = false;
          costEl.readOnly  = false;
        }
      });

      // æœŸé–“å†…ã‚»ãƒ«ã«å¯¾ã—ã¦è²»ç›®åˆ¥ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨
      onExpenseTypeChange(rowId);
    }

    function onExpenseTypeChange(rowId){
      const row = getRowEl(rowId);
      if (!row) return;

      const project = getSelectedProjectByRow(rowId);
      const expenseEl = row.querySelector('select.expense-type');
      const rankEl = row.querySelector('select.rank-select');
      const unitEl = row.querySelector('input.unit-price');

      const expense = expenseEl ? expenseEl.value : '';

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ï¼šä¸¡æ–¹å…¥åŠ›å¯ï¼ˆè²»ç›®æœªé¸æŠï¼‰
      let rankDisabled = false;
      let unitDisabled = false;
      let unitReadOnly = false;

      if (expense === 'direct'){
        // ç›´èª²çµŒè²»ï¼šãƒ©ãƒ³ã‚¯ä¸è¦ã€å˜ä¾¡ä¸è¦
        rankDisabled = true;
        unitDisabled = true;
        unitReadOnly = true;
        unitEl.value = '';
      }else if (expense === 'employee'){
        // ç¤¾å“¡äººå·¥è²»ï¼šå˜ä¾¡ã¯ãƒ©ãƒ³ã‚¯ã«å¾“ã„è‡ªå‹•è¨­å®šï¼†ç·¨é›†ä¸å¯
        rankDisabled = false;
        unitDisabled = false;
        unitReadOnly = true;
      }else if (expense === 'outsourcing'){
        // å¤–æ³¨è²»ï¼šãƒ©ãƒ³ã‚¯ã§åˆæœŸå€¤ã‚»ãƒƒãƒˆã€ç·¨é›†å¯
        rankDisabled = false;
        unitDisabled = false;
        unitReadOnly = false;
      }else{
        // æœªé¸æŠï¼šè‡ªç”±å…¥åŠ›
        rankDisabled = false;
        unitDisabled = false;
        unitReadOnly = false;
      }

      if (rankEl) rankEl.disabled = rankDisabled;
      if (unitEl){
        unitEl.disabled = unitDisabled;
        unitEl.readOnly = unitReadOnly;
        if (unitDisabled) unitEl.value = '';
      }

      // æœˆåˆ¥å…¥åŠ›å¯å¦ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆæœŸé–“å†…ã®ã¿é©ç”¨ï¼‰
      months.forEach(m => {
        const hoursEl = row.querySelector(`.hours-input[data-month="${m}"]`);
        const costEl  = row.querySelector(`.cost-input[data-month="${m}"]`);
        if (!hoursEl || !costEl) return;

        const inPeriod = isMonthInProject(project, m);
        if (!inPeriod){
          // æœŸé–“å¤–ã¯æ—¢ã« disabled
          return;
        }

        if (expense === 'employee' || expense === 'outsourcing'){
          // å·¥æ•°å…¥åŠ›å¯ã€è²»ç”¨ã¯è‡ªå‹•è¨ˆç®—ï¼ˆreadOnlyï¼‰
          hoursEl.disabled = false;
          hoursEl.readOnly = false;
          costEl.disabled = false;
          costEl.readOnly = true;
        }else if (expense === 'direct'){
          // å·¥æ•°å…¥åŠ›ä¸å¯ã€è²»ç”¨æ‰‹å…¥åŠ›å¯
          hoursEl.value = '';
          hoursEl.disabled = true;
          hoursEl.readOnly = true;

          costEl.disabled = false;
          costEl.readOnly = false;
        }else{
          // æœªé¸æŠï¼šä¸¡æ–¹å…¥åŠ›å¯ï¼ˆåˆæœŸåŒ–ã—ã¦ã‚ˆã„ï¼‰
          hoursEl.disabled = false;
          hoursEl.readOnly = false;

          costEl.disabled = false;
          costEl.readOnly = false;
        }
      });

      // ãƒ©ãƒ³ã‚¯å˜ä¾¡åæ˜  & å†è¨ˆç®—
      if (expense === 'employee' || expense === 'outsourcing'){
        onRankChange(rowId); // rankChange å†…ã§å†è¨ˆç®—
      }else{
        // ç›´èª²çµŒè²»ã‚„æœªé¸æŠï¼šå˜ä¾¡è¨ˆç®—ä¸è¦ã ãŒã€ç¤¾å“¡/å¤–æ³¨ã‹ã‚‰åˆ‡ã‚Šæ›¿ãˆãŸå ´åˆã«è²»ç”¨ã‚’å†è¨ˆç®—/è§£é™¤
        months.forEach(m => {
          const inPeriod = isMonthInProject(project, m);
          if (!inPeriod) return;
          if (expense === 'direct'){
            // directã¯è²»ç”¨æ‰‹å…¥åŠ›ãªã®ã§è¨ˆç®—ã—ãªã„
          }else if (expense === ''){
            // æœªé¸æŠï¼šä½•ã‚‚ã—ãªã„ï¼ˆæ‰‹å…¥åŠ›ç¶­æŒï¼‰
          }
        });
        updateSummary();
      }
    }

    function onRankChange(rowId){
      const row = getRowEl(rowId);
      if (!row) return;

      const expenseEl = row.querySelector('select.expense-type');
      const rankEl = row.querySelector('select.rank-select');
      const unitEl = row.querySelector('input.unit-price');
      const expense = expenseEl ? expenseEl.value : '';
      const rank = rankEl ? rankEl.value : '';

      if (expense === 'employee' || expense === 'outsourcing'){
        const price = rankPrices[toIntSafe(rank)] || 0;
        if (unitEl){
          unitEl.value = price ? formatComma(price) : '';
          unitEl.disabled = false;
          unitEl.readOnly = (expense === 'employee'); // ç¤¾å“¡ã¯ç·¨é›†ä¸å¯
        }
        // å…¨æœˆå†è¨ˆç®—
        months.forEach(m => calculateCost(rowId, m));
      }else{
        // direct / æœªé¸æŠã¯å˜ä¾¡æ›´æ–°ä¸è¦
      }

      updateSummary();
    }

    function onUnitPriceTyping(rowId){
      const row = getRowEl(rowId);
      if (!row) return;

      const expense = row.querySelector('select.expense-type')?.value || '';
      const unitEl  = row.querySelector('input.unit-price');
      if (!unitEl) return;

      // ç›´èª²çµŒè²»ã¯ä½¿ã‚ãªã„
      if (expense === 'direct') return;

      onCurrencyTyping(unitEl);

      // å˜ä¾¡ç·¨é›†ã—ãŸã‚‰å†è¨ˆç®—ï¼ˆç¤¾å“¡ã¯ readOnly ã®ãŸã‚å®Ÿè³ªç·¨é›†ä¸å¯ï¼‰
      months.forEach(m => calculateCost(rowId, m));
      updateSummary();
    }

    function onHoursChange(rowId, month){
      const row = getRowEl(rowId);
      if (!row) return;

      const hoursEl = row.querySelector(`.hours-input[data-month="${month}"]`);
      if (!hoursEl) return;

      let v = Number(hoursEl.value);
      if (!Number.isFinite(v)) v = 0;
      if (v < 0) v = 0;
      if (v > 250) v = 250;
      // step=0.1ãªã®ã§å°æ•°ã¯è¨±å®¹ï¼ˆè¡¨ç¤ºã¯ãã®ã¾ã¾ï¼‰
      hoursEl.value = v;

      calculateCost(rowId, month);
      updateSummary();
    }

    function onCostInputChange(rowId, month){
      const row = getRowEl(rowId);
      if (!row) return;

      const project = getSelectedProjectByRow(rowId);
      // æœŸé–“å¤–ã¯å…¥åŠ›ä¸å¯ã ãŒå¿µã®ãŸã‚
      if (!isMonthInProject(project, month)) return;

      const expense = row.querySelector('select.expense-type')?.value || '';
      const costEl = row.querySelector(`.cost-input[data-month="${month}"]`);
      if (!costEl) return;

      // ç¤¾å“¡/å¤–æ³¨ã®è²»ç”¨ã¯è‡ªå‹•è¨ˆç®—ï¼ˆreadOnlyæƒ³å®šï¼‰ã ãŒã€å¿µã®ãŸã‚ã‚¬ãƒ¼ãƒ‰
      if (expense === 'employee' || expense === 'outsourcing'){
        calculateCost(rowId, month);
        updateSummary();
        return;
      }

      // ç›´èª²çµŒè²» or æœªé¸æŠï¼šæ‰‹å…¥åŠ›ï¼ˆã‚«ãƒ³ãƒæ•´å½¢ï¼‰
      onCurrencyTyping(costEl);
      updateSummary();
    }

    function calculateCost(rowId, month){
      const row = getRowEl(rowId);
      if (!row) return;

      const project = getSelectedProjectByRow(rowId);
      if (!isMonthInProject(project, month)) return;

      const expense = row.querySelector('select.expense-type')?.value || '';
      const unitEl  = row.querySelector('input.unit-price');
      const hoursEl = row.querySelector(`.hours-input[data-month="${month}"]`);
      const costEl  = row.querySelector(`.cost-input[data-month="${month}"]`);

      if (!hoursEl || !costEl) return;

      if (expense === 'employee' || expense === 'outsourcing'){
        const unit = parseNumberLike(unitEl ? unitEl.value : '');
        const hours = Number(hoursEl.value || 0);
        const cost = unit * hours;
        costEl.value = cost ? formatComma(cost) : '';
      }else{
        // direct / æœªé¸æŠï¼šè¨ˆç®—ã—ãªã„
      }
    }

    // =========================
    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³3ï¼šPLï¼ˆæç›Šè¡¨ï¼‰
    // =========================
    function updateSummary(){
      const area = document.getElementById('plArea');

      if (projects.length === 0){
        area.innerHTML = `<div class="muted">æ¡ˆä»¶ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>`;
        return;
      }

      // æ¡ˆä»¶ã”ã¨ã« PL ã‚’æ§‹ç¯‰ï¼ˆå‰Šé™¤æ¸ˆæ¡ˆä»¶ã¯ projects ã‹ã‚‰æ¶ˆãˆã¦ã„ã‚‹ã®ã§è¡¨ç¤ºã—ãªã„ï¼‰
      area.innerHTML = projects.map(p => {
        return `
          <div class="pl-table">
            ${buildProjectPLHtml(p)}
          </div>
        `;
      }).join('');
    }

    function buildProjectPLHtml(project){
      // åŸä¾¡é›†è¨ˆï¼šè²»ç›®åˆ¥ãƒ»æœˆåˆ¥
      const costMap = {
        employee: Object.fromEntries(months.map(m => [m, 0])),
        outsourcing: Object.fromEntries(months.map(m => [m, 0])),
        direct: Object.fromEntries(months.map(m => [m, 0]))
      };

      // åŸä¾¡å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰èª­ã¿å–ã‚Šï¼ˆæ¡ˆä»¶å‰Šé™¤æ¸ˆã®è¡Œã¯ project ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã®ã§é™¤å¤–ï¼‰
      const rows = Array.from(document.querySelectorAll('#costTbody tr'));
      for (const tr of rows){
        const pid = tr.querySelector('select.project-select')?.value || '';
        if (!pid) continue;
        if (pid !== project.id) continue; // å¯¾è±¡æ¡ˆä»¶ã®ã¿

        const expense = tr.querySelector('select.expense-type')?.value || '';
        if (!['employee','outsourcing','direct'].includes(expense)) continue;

        for (const m of months){
          const costEl = tr.querySelector(`.cost-input[data-month="${m}"]`);
          const val = parseNumberLike(costEl ? costEl.value : '');
          if (val) costMap[expense][m] += val;
        }
      }

      // æœˆåˆ¥ã®å£²ä¸ŠåŸä¾¡ï¼ˆ=ç¤¾å“¡+å¤–æ³¨+ç›´èª²ï¼‰
      const cogs = Object.fromEntries(months.map(m => [m, costMap.employee[m] + costMap.outsourcing[m] + costMap.direct[m]]));

      // ç·åŸä¾¡è¦‹è¾¼
      const totalCost = months.reduce((s,m) => s + cogs[m], 0);

      // é€²æ—ï¼ˆåŸä¾¡ç´¯è¨ˆ/ç·åŸä¾¡è¦‹è¾¼ï¼‰ï¼šé–‹å§‹æœˆâ†’çµ‚äº†æœˆ ã®é †åºã§ç´¯è¨ˆã‚’ä½œã‚Šã€è¡¨ç¤ºåˆ—ã¸ãƒãƒƒãƒ”ãƒ³ã‚°
      const seq = getProjectMonthSequence(project);
      const cumCostByMonth = Object.fromEntries(months.map(m => [m, 0]));

      let cum = 0;
      for (const m of seq){
        cum += cogs[m] || 0;
        cumCostByMonth[m] = cum;
      }

      const progressRateByMonth = Object.fromEntries(months.map(m => {
        const inPeriod = isMonthInProject(project, m);
        if (!inPeriod) return [m, 0];
        if (totalCost <= 0) return [m, 0];
        return [m, Math.min(1, (cumCostByMonth[m] || 0) / totalCost)];
      }));

      // é€²è¡Œå£²ä¸Šï¼ˆå—æ³¨é‡‘é¡Ã—é€²æ—ç‡ï¼‰â€¦æœˆåˆ¥ã¯ç´¯è¨ˆå´ã®å€¤ã¨ã—ã¦è¡¨ç¤ºï¼ˆä»•æ§˜é€šã‚Šï¼‰
      const progressSales = Object.fromEntries(months.map(m => {
        const inPeriod = isMonthInProject(project, m);
        return [m, inPeriod ? project.amount * progressRateByMonth[m] : 0];
      }));

      // å¤–éƒ¨å£²ä¸Šï¼šçµ‚äº†æœˆã«ä¸€æ‹¬è¨ˆä¸Š
      const externalSales = Object.fromEntries(months.map(m => [m, (m === project.endMonth ? project.amount : 0)]));

      // å£²ä¸Šé«˜ï¼ˆå¤–éƒ¨å£²ä¸Š+é€²è¡Œå£²ä¸Šï¼‰ï¼šå„æœˆã¯ãã®åˆè¨ˆï¼ˆåˆè¨ˆåˆ—ã¯ç©ºã§ã‚‚ã‚ˆã„ï¼‰
      const salesTotal = Object.fromEntries(months.map(m => [m, externalSales[m] + progressSales[m]]));

      // ä»˜åŠ ä¾¡å€¤ï¼šé€²è¡Œå£²ä¸Šã¨åŒã˜
      const valueAdded = Object.fromEntries(months.map(m => [m, progressSales[m]]));
      // ç›´èª²é…åˆ†ï¼ˆç›´èª²çµŒè²»ï¼‰ï¼šå½“æœˆã®ç›´èª²çµŒè²»
      const directAlloc = Object.fromEntries(months.map(m => [m, costMap.direct[m]]));

      // å£²ä¸Šé…åˆ†ï¼ˆä»˜åŠ ä¾¡å€¤ï¼‹ç›´èª²é…åˆ†ï¼‰
      const allocation = Object.fromEntries(months.map(m => [m, valueAdded[m] + directAlloc[m]]));

      // å£²ä¸ŠåŸä¾¡ï¼ˆç¤¾å“¡äººå·¥è²»ï¼‹å¤–æ³¨äººå·¥è²»ï¼‹ç›´èª²çµŒè²»ï¼‰
      const cogsTotal = Object.fromEntries(months.map(m => [m, cogs[m]]));
      const cogsSum = totalCost;

      // å£²ä¸Šç·åˆ©ç›Šï¼å£²ä¸Šé…åˆ†âˆ’å£²ä¸ŠåŸä¾¡
      const grossProfit = Object.fromEntries(months.map(m => [m, allocation[m] - cogsTotal[m]]));

      // å—æ³¨é‡‘é¡ï¼šé–‹å§‹æœˆã«è¨ˆä¸Š
      const orderAmountByMonth = Object.fromEntries(months.map(m => [m, (m === project.startMonth ? project.amount : 0)]));

      // åŸä¾¡ç´¯è¨ˆï¼šé–‹å§‹æœˆâ†’çµ‚äº†æœˆã®ç´¯è¨ˆï¼ˆè¡¨ç¤ºæœˆã¸ãƒãƒƒãƒ”ãƒ³ã‚°æ¸ˆï¼‰
      // åˆè¨ˆåˆ—ã¯ç·åŸä¾¡è¦‹è¾¼ã¨åŒã˜
      const cumCostTotal = cogsSum;

      // é€²æ—ç‡ï¼ˆåŸä¾¡ç´¯è¨ˆ/ç·åŸä¾¡è¦‹è¾¼ï¼‰ï¼šæœˆåˆ¥
      const rateTotal = (totalCost > 0) ? 1 : 0; // æœ€çµ‚æœˆãŒ100%ã‚¤ãƒ¡ãƒ¼ã‚¸

      // ---- helpers for rendering ----
      const colHeads = ['é …ç›®å','åˆè¨ˆ', ...months.map(m => `${m}æœˆ`)];
      function thRow(){
        return `<tr>${colHeads.map((h,i)=>`<th class="${i<=1?'':' '}">${escapeHtml(h)}</th>`).join('')}</tr>`;
      }
      function rowMoney(label, total, map, opts={}){
        const blankTotal = !!opts.blankTotal;
        const blankIfZero = !!opts.blankIfZero;
        return `
          <tr>
            <td class="pl-left ${opts.classLeft||''}">${escapeHtml(label)}</td>
            <td class="num">${blankTotal ? '' : formatCommaMaybeBlank(total, false)}</td>
            ${months.map(m => `<td class="num">${formatCommaMaybeBlank(map[m] || 0, blankIfZero)}</td>`).join('')}
          </tr>
        `;
      }
      function rowPercent(label, totalRate, map){
        return `
          <tr>
            <td class="pl-left">${escapeHtml(label)}</td>
            <td class="num">${formatPercent(totalRate)}</td>
            ${months.map(m => `<td class="num">${formatPercent(map[m] || 0)}</td>`).join('')}
          </tr>
        `;
      }

      // å£²ä¸Šé«˜ï¼ˆå¤–éƒ¨+é€²è¡Œï¼‰â€¦åˆè¨ˆåˆ—ã¯ãƒ–ãƒ©ãƒ³ã‚¯ã§ã‚‚ã‚ˆã„
      const html = `
        <table>
          <caption>${escapeHtml(project.name)}</caption>
          <thead>
            ${thRow()}
          </thead>
          <tbody>
            <tr class="pl-group">
              <td class="pl-left">å£²ä¸Šé«˜ï¼ˆå¤–éƒ¨å£²ä¸Š+é€²è¡Œå£²ä¸Šï¼‰</td>
              <td class="num"></td>
              ${months.map(m => `<td class="num">${formatCommaMaybeBlank(salesTotal[m] || 0, true)}</td>`).join('')}
            </tr>

            ${rowMoney('å¤–éƒ¨å£²ä¸Š', project.amount, externalSales, { blankIfZero:true, classLeft:'pl-sub' })}
            ${rowMoney('é€²è¡Œå£²ä¸Š', progressSales[project.endMonth] || 0, progressSales, { blankIfZero:true, classLeft:'pl-sub' })}

            <tr class="pl-group">
              <td class="pl-left">å£²ä¸Šé…åˆ†ï¼ˆä»˜åŠ ä¾¡å€¤ï¼‹ç›´èª²é…åˆ†ï¼‰</td>
              <td class="num"></td>
              ${months.map(m => `<td class="num">${formatCommaMaybeBlank(allocation[m] || 0, true)}</td>`).join('')}
            </tr>

            ${rowMoney('ä»˜åŠ ä¾¡å€¤', valueAdded[project.endMonth] || 0, valueAdded, { blankIfZero:true, classLeft:'pl-sub' })}
            ${rowMoney('ç›´èª²é…åˆ†ï¼ˆç›´èª²çµŒè²»ï¼‰', months.reduce((s,m)=>s + directAlloc[m], 0), directAlloc, { blankIfZero:true, classLeft:'pl-sub' })}

            <tr class="pl-group">
              <td class="pl-left">å£²ä¸ŠåŸä¾¡ï¼ˆç¤¾å“¡äººå·¥è²»ï¼‹å¤–æ³¨äººå·¥è²»ï¼‹ç›´èª²çµŒè²»ï¼‰</td>
              <td class="num">${formatCommaMaybeBlank(cogsSum, false)}</td>
              ${months.map(m => `<td class="num">${formatCommaMaybeBlank(cogsTotal[m] || 0, true)}</td>`).join('')}
            </tr>

            ${rowMoney('ç¤¾å“¡äººå·¥è²»', months.reduce((s,m)=>s + costMap.employee[m], 0), costMap.employee, { blankIfZero:true, classLeft:'pl-sub' })}
            ${rowMoney('å¤–æ³¨äººå·¥è²»', months.reduce((s,m)=>s + costMap.outsourcing[m], 0), costMap.outsourcing, { blankIfZero:true, classLeft:'pl-sub' })}
            ${rowMoney('ç›´èª²çµŒè²»', months.reduce((s,m)=>s + costMap.direct[m], 0), costMap.direct, { blankIfZero:true, classLeft:'pl-sub' })}

            ${rowMoney('å£²ä¸Šç·åˆ©ç›Š', '', grossProfit, { blankTotal:true, blankIfZero:true })}

            ${rowMoney('å—æ³¨é‡‘é¡', project.amount, orderAmountByMonth, { blankIfZero:true })}

            ${rowMoney('åŸä¾¡ç´¯è¨ˆ', cumCostTotal, cumCostByMonth, { blankIfZero:true })}

            <tr>
              <td class="pl-left">ç·åŸä¾¡è¦‹è¾¼</td>
              <td class="num">${formatCommaMaybeBlank(cogsSum, false)}</td>
              ${months.map(_ => `<td class="num"></td>`).join('')}
            </tr>

            ${rowPercent('é€²æ—ç‡ï¼ˆåŸä¾¡ç´¯è¨ˆ/ç·åŸä¾¡è¦‹è¾¼ï¼‰', rateTotal, progressRateByMonth)}
          </tbody>
        </table>
      `;
      return html;
    }

    // =========================
    // Init
    // =========================
    function escapeHtml(str){
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
    function escapeAttr(str){ return escapeHtml(str); }

    function init(){
      // month selects
      document.getElementById('startMonth').innerHTML = buildMonthSelectOptions(true);
      document.getElementById('endMonth').innerHTML   = buildMonthSelectOptions(true);

      // amount input live format
      const amtEl = document.getElementById('projectAmount');
      amtEl.addEventListener('input', () => onCurrencyTyping(amtEl));
      amtEl.addEventListener('blur', () => formatCurrencyInput(amtEl));

      renderProjectList();
      updateSummary();
    }
    init();
  </script>
</body>
</html>
