<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mermaid業務フロー 変換ツール</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Arial, sans-serif; margin: 0; }
    header { padding: 12px 16px; border-bottom: 1px solid rgba(127,127,127,.3); }
    main { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
    @media (max-width: 980px) { main { grid-template-columns: 1fr; } }
    .panel { border: 1px solid rgba(127,127,127,.3); border-radius: 10px; overflow: hidden; }
    .panel h2 { margin: 0; padding: 10px 12px; font-size: 14px; border-bottom: 1px solid rgba(127,127,127,.3); }
    textarea {
      width: 100%; height: 68vh; min-height: 340px;
      border: 0; outline: none; resize: vertical;
      padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Noto Sans Mono", monospace;
      font-size: 13px; line-height: 1.45;
    }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 12px; border-bottom: 1px solid rgba(127,127,127,.3); align-items: center; }
    button, select {
      border: 1px solid rgba(127,127,127,.4);
      background: transparent;
      padding: 6px 10px; border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background: rgba(127,127,127,.12); }
    .status { margin-left: auto; font-size: 12px; opacity: .8; }
    #previewWrap { padding: 12px; overflow: auto; height: 68vh; min-height: 340px; }
    #preview { display: inline-block; }
    .hint { font-size: 12px; opacity: .8; padding: 10px 12px; border-top: 1px solid rgba(127,127,127,.3); }
    .error { color: #d33; white-space: pre-wrap; font-family: ui-monospace, monospace; font-size: 12px; }
    .ok { color: #2a7; }
  </style>

  <!-- Mermaid (ESM) -->
  <script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";

    // ---- Utils ----
    const $ = (sel) => document.querySelector(sel);

    function extractMermaidCode(text) {
      // Accept:
      // 1) ```mermaid ... ```
      // 2) Mermaid code alone
      const fenceMatch = text.match(/```mermaid\s*([\s\S]*?)```/i);
      if (fenceMatch && fenceMatch[1]) return fenceMatch[1].trim();
      return text.trim();
    }

    function downloadText(filename, content, mime = "text/plain") {
      const blob = new Blob([content], { type: mime });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 500);
    }

    function svgToPngDataUrl(svgString, scale = 2) {
      return new Promise((resolve, reject) => {
        const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
        const url = URL.createObjectURL(svgBlob);
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = Math.ceil(img.width * scale);
          canvas.height = Math.ceil(img.height * scale);
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          URL.revokeObjectURL(url);
          resolve(canvas.toDataURL("image/png"));
        };
        img.onerror = (e) => {
          URL.revokeObjectURL(url);
          reject(e);
        };
        img.src = url;
      });
    }

    function downloadDataUrl(filename, dataUrl) {
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      a.click();
    }

    // ---- Mermaid init ----
    mermaid.initialize({
      startOnLoad: false,
      securityLevel: "strict", // safer. If you need HTML labels, change to "loose"
      theme: "default",
      flowchart: { curve: "linear" },
    });

    // ---- App state ----
    let lastSvg = "";
    let renderTimer = null;

    async function render() {
      const raw = $("#input").value;
      const code = extractMermaidCode(raw);

      $("#error").textContent = "";
      $("#status").textContent = "Rendering...";
      $("#status").className = "";

      if (!code) {
        $("#preview").innerHTML = "";
        $("#status").textContent = "No input";
        return;
      }

      // apply theme
      const theme = $("#theme").value;
      mermaid.initialize({ theme });

      try {
        const id = "m_" + Math.random().toString(16).slice(2);
        const { svg } = await mermaid.render(id, code);
        lastSvg = svg;
        $("#preview").innerHTML = svg;
        $("#status").textContent = "OK";
        $("#status").className = "ok";
      } catch (err) {
        lastSvg = "";
        $("#preview").innerHTML = "";
        $("#error").textContent = String(err?.message || err);
        $("#status").textContent = "Error";
        $("#status").className = "";
      }
    }

    function scheduleRender() {
      clearTimeout(renderTimer);
      renderTimer = setTimeout(render, 250);
    }

    function setSample() {
      $("#input").value = `\`\`\`mermaid
flowchart TD
  A[依頼受領] --> B{内容OK?}
  B -- Yes --> C[登録]
  B -- No --> D[差戻し]
  C --> E[完了通知]
\`\`\``;
      render();
    }

    // ---- Events ----
    window.addEventListener("DOMContentLoaded", () => {
      $("#input").addEventListener("input", scheduleRender);
      $("#theme").addEventListener("change", render);

      $("#btnRender").addEventListener("click", render);
      $("#btnSample").addEventListener("click", setSample);

      $("#btnDownloadSvg").addEventListener("click", () => {
        if (!lastSvg) return alert("まずは正常にレンダリングしてください。");
        downloadText("flow.svg", lastSvg, "image/svg+xml");
      });

      $("#btnDownloadPng").addEventListener("click", async () => {
        if (!lastSvg) return alert("まずは正常にレンダリングしてください。");
        try {
          const scale = Number($("#pngScale").value || 2);
          const pngUrl = await svgToPngDataUrl(lastSvg, scale);
          downloadDataUrl("flow.png", pngUrl);
        } catch (e) {
          alert("PNG変換に失敗しました: " + (e?.message || e));
        }
      });

      $("#btnCopySvg").addEventListener("click", async () => {
        if (!lastSvg) return alert("まずは正常にレンダリングしてください。");
        try {
          await navigator.clipboard.writeText(lastSvg);
          $("#status").textContent = "SVG copied";
          $("#status").className = "ok";
        } catch {
          alert("クリップボードにコピーできませんでした。");
        }
      });

      // initial
      setSample();
    });
  </script>
</head>

<body>
  <header>
    <strong>Mermaid業務フロー 変換ツール</strong>
    <span style="opacity:.8; margin-left:8px; font-size:12px;">Mermaidコード → 図表示 / SVG・PNG保存</span>
  </header>

  <main>
    <section class="panel">
      <h2>入力（Markdown / Mermaid）</h2>
      <div class="toolbar">
        <button id="btnSample" type="button">サンプル挿入</button>
        <button id="btnRender" type="button">再レンダリング</button>

        <label style="display:flex;gap:6px;align-items:center;">
          テーマ
          <select id="theme">
            <option value="default">default</option>
            <option value="neutral">neutral</option>
            <option value="dark">dark</option>
            <option value="forest">forest</option>
            <option value="base">base</option>
          </select>
        </label>

        <span class="status" id="status">-</span>
      </div>

      <textarea id="input" spellcheck="false" placeholder="```mermaid 〜 ``` もしくは Mermaidコードを貼り付け"></textarea>
      <div class="hint">
        入力は <code>```mermaid</code> フェンス付きでも、Mermaidコード単体でもOK。<br/>
        例：<code>flowchart TD</code> / <code>sequenceDiagram</code> / <code>stateDiagram-v2</code> など。
      </div>
    </section>

    <section class="panel">
      <h2>プレビュー（図）</h2>
      <div class="toolbar">
        <button id="btnDownloadSvg" type="button">SVG保存</button>
        <button id="btnCopySvg" type="button">SVGをコピー</button>

        <label style="display:flex;gap:6px;align-items:center;">
          PNG倍率
          <select id="pngScale">
            <option value="1">1x</option>
            <option value="2" selected>2x</option>
            <option value="3">3x</option>
            <option value="4">4x</option>
          </select>
        </label>
        <button id="btnDownloadPng" type="button">PNG保存</button>
      </div>

      <div id="previewWrap">
        <div id="preview"></div>
        <div id="error" class="error"></div>
      </div>

      <div class="hint">
        エラーが出る場合：文法ミス・全角記号・インデント崩れ・未対応記法を確認してください。
      </div>
    </section>
  </main>
</body>
</html>
