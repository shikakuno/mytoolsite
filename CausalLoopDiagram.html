<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>因果ループ図 Mermaid 変換ツール</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Arial, sans-serif; margin: 0; }
    header { padding: 12px 16px; border-bottom: 1px solid rgba(127,127,127,.3); display:flex; gap:10px; align-items:baseline; flex-wrap:wrap;}
    header strong { font-size: 15px; }
    header span { opacity: .8; font-size: 12px; }

    main { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
    @media (max-width: 980px) { main { grid-template-columns: 1fr; } }

    .panel { border: 1px solid rgba(127,127,127,.3); border-radius: 10px; overflow: hidden; }
    .panel h2 { margin: 0; padding: 10px 12px; font-size: 14px; border-bottom: 1px solid rgba(127,127,127,.3); }

    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 12px; border-bottom: 1px solid rgba(127,127,127,.3); align-items: center; }
    button, select, input[type="checkbox"] {
      border: 1px solid rgba(127,127,127,.4);
      background: transparent;
      padding: 6px 10px; border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background: rgba(127,127,127,.12); }

    textarea {
      width: 100%; height: 66vh; min-height: 340px;
      border: 0; outline: none; resize: vertical;
      padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Noto Sans Mono", monospace;
      font-size: 13px; line-height: 1.45;
    }

    #previewWrap { padding: 12px; overflow: auto; height: 66vh; min-height: 340px; }
    #preview { display: inline-block; }
    .hint { font-size: 12px; opacity: .8; padding: 10px 12px; border-top: 1px solid rgba(127,127,127,.3); }
    .status { margin-left: auto; font-size: 12px; opacity: .85; }
    .error { color: #d33; white-space: pre-wrap; font-family: ui-monospace, monospace; font-size: 12px; }
    .ok { color: #2a7; }
    code { font-family: ui-monospace, monospace; }
  </style>

  <script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";

    const $ = (sel) => document.querySelector(sel);

    function extractMermaidCode(text) {
      const fenceMatch = text.match(/```mermaid\s*([\s\S]*?)```/i);
      if (fenceMatch && fenceMatch[1]) return fenceMatch[1].trim();
      return text.trim();
    }

    function downloadText(filename, content, mime = "text/plain") {
      const blob = new Blob([content], { type: mime });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 500);
    }

    function downloadDataUrl(filename, dataUrl) {
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      a.click();
    }

    function svgToPngDataUrl(svgString, scale = 2) {
      return new Promise((resolve, reject) => {
        const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
        const url = URL.createObjectURL(svgBlob);

        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = Math.ceil(img.width * scale);
          canvas.height = Math.ceil(img.height * scale);
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          URL.revokeObjectURL(url);
          resolve(canvas.toDataURL("image/png"));
        };
        img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      });
    }

    // Mermaid init
    mermaid.initialize({
      startOnLoad: false,
      securityLevel: "strict",
      theme: "default",
      flowchart: { curve: "basis" }, // ループが多いので曲線の方が見やすいことが多い
    });

    // 因果ループ図のサンプル（R:強化ループ / B:抑制ループ も注記）
    function cldSample() {
      return `\`\`\`mermaid
flowchart LR
  %% =========================
  %% 因果ループ図（CLD）サンプル
  %% - 矢印ラベルに「+」(同方向) / 「−」(逆方向)
  %% - ループ名 (R1, B1) を注記として置く
  %% =========================

  A[品質] -->|+| B[顧客満足]
  B -->|+| C[口コミ]
  C -->|+| D[新規顧客]
  D -->|+| E[売上]
  E -->|+| F[改善投資]
  F -->|+| A

  %% 抑制ループ例（B1）
  D -->|+| G[サポート負荷]
  G -->|−| A

  R1((R1 強化ループ))
  B1((B1 抑制ループ))
  R1 --- A
  B1 --- G
\`\`\``;
    }

    function cldTemplate() {
      return `\`\`\`mermaid
flowchart LR
  %% 因果ループ図（CLD）テンプレ
  %% 変数ノードを置いて、矢印に + / − を付ける

  X[要因X] -->|+| Y[要因Y]
  Y -->|−| Z[要因Z]
  Z -->|+| X

  R1((R1))
  R1 --- X
\`\`\``;
    }

    // App state
    let lastSvg = "";
    let renderTimer = null;

    async function render() {
      const raw = $("#input").value;
      const code = extractMermaidCode(raw);

      $("#error").textContent = "";
      $("#status").textContent = "Rendering...";
      $("#status").className = "status";

      if (!code) {
        $("#preview").innerHTML = "";
        $("#status").textContent = "No input";
        return;
      }

      const theme = $("#theme").value;
      const curved = $("#curved").checked;

      // 因果ループは循環が多いので曲線をデフォルトに
      mermaid.initialize({
        theme,
        securityLevel: "strict",
        flowchart: { curve: curved ? "basis" : "linear" },
      });

      try {
        const id = "cld_" + Math.random().toString(16).slice(2);
        const { svg } = await mermaid.render(id, code);
        lastSvg = svg;
        $("#preview").innerHTML = svg;
        $("#status").textContent = "OK";
        $("#status").className = "status ok";
      } catch (err) {
        lastSvg = "";
        $("#preview").innerHTML = "";
        $("#error").textContent = String(err?.message || err);
        $("#status").textContent = "Error";
        $("#status").className = "status";
      }
    }

    function scheduleRender() {
      clearTimeout(renderTimer);
      renderTimer = setTimeout(render, 250);
    }

    function setText(v) {
      $("#input").value = v;
      render();
    }

    window.addEventListener("DOMContentLoaded", () => {
      $("#input").addEventListener("input", scheduleRender);
      $("#theme").addEventListener("change", render);
      $("#curved").addEventListener("change", render);

      $("#btnRender").addEventListener("click", render);
      $("#btnSample").addEventListener("click", () => setText(cldSample()));
      $("#btnTemplate").addEventListener("click", () => setText(cldTemplate()));

      $("#btnDownloadSvg").addEventListener("click", () => {
        if (!lastSvg) return alert("まずは正常にレンダリングしてください。");
        downloadText("cld.svg", lastSvg, "image/svg+xml");
      });

      $("#btnCopySvg").addEventListener("click", async () => {
        if (!lastSvg) return alert("まずは正常にレンダリングしてください。");
        try {
          await navigator.clipboard.writeText(lastSvg);
          $("#status").textContent = "SVG copied";
          $("#status").className = "status ok";
        } catch {
          alert("クリップボードにコピーできませんでした。");
        }
      });

      $("#btnDownloadPng").addEventListener("click", async () => {
        if (!lastSvg) return alert("まずは正常にレンダリングしてください。");
        try {
          const scale = Number($("#pngScale").value || 2);
          const pngUrl = await svgToPngDataUrl(lastSvg, scale);
          downloadDataUrl("cld.png", pngUrl);
        } catch (e) {
          alert("PNG変換に失敗しました: " + (e?.message || e));
        }
      });

      // initial
      setText(cldSample());
    });
  </script>
</head>

<body>
  <header>
    <strong>因果ループ図 Mermaid 変換ツール</strong>
    <span>Mermaid（CLDのMarkdown）→ 図表示 / SVG・PNG保存</span>
  </header>

  <main>
    <section class="panel">
      <h2>入力（Markdown / Mermaid）</h2>
      <div class="toolbar">
        <button id="btnSample" type="button">CLDサンプル</button>
        <button id="btnTemplate" type="button">CLDテンプレ</button>
        <button id="btnRender" type="button">再レンダリング</button>

        <label style="display:flex;gap:6px;align-items:center;">
          テーマ
          <select id="theme">
            <option value="default">default</option>
            <option value="neutral">neutral</option>
            <option value="dark">dark</option>
            <option value="forest">forest</option>
            <option value="base">base</option>
          </select>
        </label>

        <label style="display:flex;gap:8px;align-items:center;">
          <input id="curved" type="checkbox" checked />
          曲線（ループ向き）
        </label>

        <span class="status" id="status">-</span>
      </div>

      <textarea id="input" spellcheck="false"
        placeholder="```mermaid 〜 ``` または Mermaidコードを貼り付け（CLDは flowchart LR 推奨）"></textarea>

      <div class="hint">
        因果ループ図は <code>flowchart</code> で、矢印ラベルに <code>+ / −</code> を付けるのが扱いやすいです。例：<code>A -->|+| B</code><br/>
        強化ループは <code>R1</code>、抑制ループは <code>B1</code> のように注記ノードを置くと読みやすいです。
      </div>
    </section>

    <section class="panel">
      <h2>プレビュー（図）</h2>
      <div class="toolbar">
        <button id="btnDownloadSvg" type="button">SVG保存</button>
        <button id="btnCopySvg" type="button">SVGをコピー</button>

        <label style="display:flex;gap:6px;align-items:center;">
          PNG倍率
          <select id="pngScale">
            <option value="1">1x</option>
            <option value="2" selected>2x</option>
            <option value="3">3x</option>
            <option value="4">4x</option>
          </select>
        </label>

        <button id="btnDownloadPng" type="button">PNG保存</button>
      </div>

      <div id="previewWrap">
        <div id="preview"></div>
        <div id="error" class="error"></div>
      </div>

      <div class="hint">
        エラーが出る場合：ラベルの記号（<code>−</code> が全角になっていないか）／引用符／インデント崩れを確認してください。
      </div>
    </section>
  </main>
</body>
</html>
